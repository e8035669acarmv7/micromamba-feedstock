From 5ca84c4fcf58fff1c8e45da0db4efdfb3069ce73 Mon Sep 17 00:00:00 2001
From: Yu-Ren Zhang <e8035669@gmail.com>
Date: Mon, 15 May 2023 22:40:58 +0800
Subject: [PATCH 5/5] revert fetch.cpp and change only curl.cpp

---
 libmamba/src/core/curl.cpp  | 12 ++++++++++--
 libmamba/src/core/fetch.cpp |  8 ++++----
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/libmamba/src/core/curl.cpp b/libmamba/src/core/curl.cpp
index 107b9ae6..18f3bb74 100644
--- a/libmamba/src/core/curl.cpp
+++ b/libmamba/src/core/curl.cpp
@@ -286,7 +286,7 @@ namespace mamba
     template tl::expected<long, CURLcode> CURLHandle::get_info(CURLINFO option);
     template tl::expected<char*, CURLcode> CURLHandle::get_info(CURLINFO option);
     template tl::expected<double, CURLcode> CURLHandle::get_info(CURLINFO option);
-    template tl::expected<curl_off_t, CURLcode> CURLHandle::get_info(CURLINFO option);
+    template tl::expected<long long, CURLcode> CURLHandle::get_info(CURLINFO option);
     template tl::expected<curl_slist*, CURLcode> CURLHandle::get_info(CURLINFO option);
 
     template <class I>
@@ -306,7 +306,15 @@ namespace mamba
     template <>
     tl::expected<std::size_t, CURLcode> CURLHandle::get_info(CURLINFO option)
     {
-        return get_integer_info<std::size_t>(option);
+        auto res = get_info<curl_off_t>(option);
+        if (res)
+        {
+            return static_cast<std::size_t>(res.value());
+        }
+        else
+        {
+            return tl::unexpected(res.error());
+        }
     }
 
     template <>
diff --git a/libmamba/src/core/fetch.cpp b/libmamba/src/core/fetch.cpp
index 7b4478da..d27c2a85 100644
--- a/libmamba/src/core/fetch.cpp
+++ b/libmamba/src/core/fetch.cpp
@@ -521,7 +521,7 @@ namespace mamba
 
     std::size_t DownloadTarget::get_speed()
     {
-        auto speed = m_curl_handle->get_info<curl_off_t>(CURLINFO_SPEED_DOWNLOAD_T);
+        auto speed = m_curl_handle->get_info<std::size_t>(CURLINFO_SPEED_DOWNLOAD_T);
         // TODO Should we just drop all code below with progress_bar and use value_or(0) in get_info
         // above instead?
         if (!speed.has_value())
@@ -535,7 +535,7 @@ namespace mamba
                 return 0;
             }
         }
-        return static_cast<std::size_t>(speed.value());
+        return speed.value();
     }
 
     bool DownloadTarget::resource_exists()
@@ -614,7 +614,7 @@ namespace mamba
         auto avg_speed = get_speed();
         m_http_status = m_curl_handle->get_info<int>(CURLINFO_RESPONSE_CODE).value_or(10000);
         m_effective_url = m_curl_handle->get_info<char*>(CURLINFO_EFFECTIVE_URL).value();
-        m_downloaded_size = m_curl_handle->get_info<curl_off_t>(CURLINFO_SIZE_DOWNLOAD_T).value_or(0);
+        m_downloaded_size = m_curl_handle->get_info<std::size_t>(CURLINFO_SIZE_DOWNLOAD_T).value_or(0);
 
         LOG_INFO << get_transfer_msg();
 
@@ -623,7 +623,7 @@ namespace mamba
             // this request didn't work!
 
             // respect Retry-After header if present, otherwise use default timeout
-            m_retry_wait_seconds = m_curl_handle->get_info<curl_off_t>(CURLINFO_RETRY_AFTER)
+            m_retry_wait_seconds = m_curl_handle->get_info<std::size_t>(CURLINFO_RETRY_AFTER)
                                        .value_or(0);
             if (!m_retry_wait_seconds)
             {
-- 
2.20.1

